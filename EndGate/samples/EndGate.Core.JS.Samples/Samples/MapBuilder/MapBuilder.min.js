var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},MapBuilder=function(n){function t(t,i,r,u,f,e,o){var s=this,h,c;n.call(this,t),this._spriteSheetViewer=r,this._rows=u,this._columns=f,this._tileWidth=e,this._tileHeight=o,h=$("#addLayer"),c=$("#layerName"),this._layersSelect=$("#layers"),this._visibleGrid=new eg.Graphics.Grid(t.width/2,t.height/2,u,f,e,o,!0),this._visibleGrid.ZIndex=100,this._layers=[{Name:"Background",Layer:new eg.Graphics.Grid(this._visibleGrid.Position.X,this._visibleGrid.Position.Y,u,f,e,o)}],this._cameraDragController=new CameraDragController(t,this.Scene.Camera,this.Input.Keyboard,this.Input.Mouse),this._cameraZoomController=new CameraZoomController(this.Scene.Camera,this.Input.Mouse),this._persistenceManager=new PersistenceManager(i,function(){return s._layers},r.SpriteSheetUrl,function(n){return s.BuildResourceMap(n)}),this._outputHandler=new OutputHandler(i,this._persistenceManager,r,e,o),this.Scene.Add(this._visibleGrid),this.Scene.Add(this._layers[0].Layer),this._tileFiller=new TileFiller(this._layers[0].Layer,e,o),this._tileSelector=new TileSelector(this._visibleGrid,this.Scene,this.Scene.Camera,this._cameraDragController,this.Input.Mouse,function(n){s._tileFiller.Fill(n,s._spriteSheetViewer.SelectedSources)},function(n){s._tileFiller.Clear(n)}),h.click(function(){s.AddLayer(c.val()),c.val(""),h.blur()}),this._layersSelect.change(function(){s._tileFiller.ChangeGrid(s._layers[parseInt(s._layersSelect.val())].Layer)})}return __extends(t,n),t.prototype.AddLayer=function(n){var t={Name:n,Layer:new eg.Graphics.Grid(this._visibleGrid.Position.X,this._visibleGrid.Position.Y,this._rows,this._columns,this._tileWidth,this._tileHeight)};return this._layers.push(t),this._layersSelect.append($("<option value='"+(this._layers.length-1)+"'>"+t.Name+"<\/option>")),this._layersSelect.val((this._layers.length-1).toString()),this._tileFiller.ChangeGrid(t.Layer),this.Scene.Add(t.Layer),t},t.prototype.BuildResourceMap=function(n){for(var f=this._spriteSheetViewer.VisibleGrid.GetSpace(0,0,this._spriteSheetViewer.VisibleGrid.Rows()-1,this._spriteSheetViewer.VisibleGrid.Columns()-1),e=n.Rows(),o=n.Columns(),r,u=[],i,t=0;t<e;t++)for(u[t]=[],i=0;i<o;i++)r=n.Get(t,i),u[t][i]=r?this.FindResource(r.Image,f):-1;return u},t.prototype.LoadLayersFromResourceMaps=function(n){var e=this._spriteSheetViewer.VisibleGrid.GetSpace(0,0,this._spriteSheetViewer.VisibleGrid.Rows()-1,this._spriteSheetViewer.VisibleGrid.Columns()-1),u,f,o=this._layers[0].Layer,t,i,r;for(this.Scene.Remove(o),this._layersSelect.html(""),this._layers=[],t=0;t<n.length;t++){for(f=this.AddLayer(n[t].Name),u=f.Layer,i=0;i<n[t].Layer.length;i++)for(r=0;r<n[t].Layer[i].length;r++)n[t].Layer[i][r]!==-1&&u.Fill(i,r,new eg.Graphics.Sprite2d(0,0,e[n[t].Layer[i][r]].Image,this._tileWidth,this._tileHeight));this._tileFiller.ChangeGrid(this._layers[0].Layer)}this._layersSelect.val("0")},t.prototype.FindResource=function(n,t){for(var i=0;i<t.length;i++)if(t[i].Image===n)return i;return-1},t}(eg.Game)